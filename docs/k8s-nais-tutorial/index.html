
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Kubernetes and NAIS tutorial</title>
  <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, #F8F9FA);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="Kubernetes and NAIS tutorial"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="About this tutorial" duration="0">
        <p>This tutorial walks you through Kubernetes basics and will introduce you to the features the <a href="https://nais.io" target="_blank">NAIS</a> platform provides you.</p>
<h2>About Kubernetes</h2>
<p><a href="https://kubernetes.io" target="_blank">Kubernetes</a> is a system for deploying and managing conterinized applications. Not familiar with containers? Don&#39;t worry, you will learn about it in this tutorial as well.</p>
<h2>About NAIS</h2>
<p>NAIS is <a href="https://nav.no" target="_blank">NAV</a>&#39;s application infrastructure platform built to increase development speed by providing our developers at NAV with the best possible tools to develop and run their applications. The platform based on Kubernetes and provides additional tools and components that our developers might need.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Prerequisites" duration="3">
        <ul>
<li>You must install the <a href="https://cloud.google.com/sdk/docs/downloads-interactive" target="_blank">gcloud-sdk</a> locally on your machine</li>
<li>Install Docker - see https://www.docker.com/get-started for instructions.</li>
<li>An account on a Docker registry, e.g. https://dockerhub.com</li>
<li>Access to a Kubernetes cluster on Google Cloud Platform</li>
<li>Clone the <a href="https://github.com/nais/nais-tutorial" target="_blank">nais-tutorial</a> repository</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Set up gcloud" duration="2">
        <p>Set up the Google Cloud SDK tool:</p>
<pre><code>gcloud init
</code></pre>
<p>When asked about whether to create a new project, say no.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Docker" duration="10">
        <p>We will in this section create a Docker image for our application, but first, lets take a look at Docker.</p>
<h2>About Docker</h2>
<p>Docker is a container technology that we can use to wrap an application into an image.</p>
<p>Take a look at the repository <code>nais-tutorial</code>. This contains source code for a small example application. As you can see, it also contains a file <code>Dockerfile</code>. This file contains instructions on how to create a Docker image for the application.</p>
<p>More info........</p>
<h2>About the Dockerfile</h2>
<h2>Create a Docker image</h2>
<p>In the folder <code>nais-tutorial</code> run this command to build a Docker image, remember to insert your username:</p>
<pre><code>docker build --tag YOUR_USERNAME/nais-demoapp:1.0 .
</code></pre>
<p>This will create an image of the application with the name YOUR_USERNAME/nais-demoapp and the tag (think of it as the version) 1.0. To list your local images:</p>
<pre><code>docker images
</code></pre>
<p>You can test the image locally by running:</p>
<pre><code>docker run -d -p 8080 YOUR_USERNAME/nais-demoapp:1.0
</code></pre>
<p>This will spin up a container based on your image.<br>To view the application in your browser, you need to find out which port it is mapped to:</p>
<pre><code>docker ps
</code></pre>
<p>Note the port mapping (<code>0.0.0.0:12345(random port) -&gt; 8080</code>) and visit <code>localhost:INSERT_RANDOM_PORT</code> in your most loved browser. You should see the text &#34;Hello, world!&#34;</p>
<h2>Push to Docker registry</h2>
<h3>Log into Dockerhub</h3>
<p>....</p>
<p>We need the docker image to be available on the internet in order to deploy it to Kubernetes. Push it to your Docker registry:</p>
<pre><code>docker push YOUR_USERNAME/nais-demoapp
</code></pre>
<p>You can see that it pushes your image in layers. (INSERT INFO ON LAYERS)</p>


      </google-codelab-step>
    
      <google-codelab-step label="Kubernetes" duration="4">
        <p>Now that we have made our Docker image available on the web, the time has come to take a look at Kubernetes. Out of the box, Kubernetes will manage your Docker containers, keep track of whether they are healthy or not and how to reach them. In this section, we will deploy our container on a Kubernetes cluster.</p>
<h2>Kubectl</h2>
<p>We need to install the Kubernetes command line tool <code>kubectl</code>. If you have installed it, skip this step.</p>
<p>You can install <code>kubectl</code> using the instructions on the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl" target="_blank">Kubernetes documentation</a> or install through the <code>gcloud</code> tool you installed in the first section:</p>
<pre><code>gcloud components install kubectl
</code></pre>
<h2>Access</h2>
<p>To deploy to the Kubernetes cluster, you need access:</p>
<pre><code>gcloud container clusters get-credentials CLUSTER_NAME --zone europe/north1-a --project PROJECT_NAME --account YOUR_EMAIL
</code></pre>
<p>This command will authenticate you against the Kubernetes cluster CLUSTER_NAME.<br>Check that you&#39;re authenticated by listing services in the cluster:</p>
<pre><code>kubectl get pods
</code></pre>
<p>It might not output anything, but as long as it doesn&#39;t give an error, you are all good.</p>
<p>The command writes to a config file, default <code>$HOME/.kube/config</code>, you can take a look at it if you&#39;re curious.</p>
<h2>Run your container</h2>
<p>You can run your container with this command:</p>
<pre><code>kubectl run YOUR_NAME-demoapp --image=YOUR_USERNAME/nais-demoapp:1.0
</code></pre>
<p>This will create your container in a Kubernetes resource that we call pod. Lets take a look at it:</p>
<pre><code>kubectl get pods
</code></pre>
<p>Pods are Kubernetes resources that mainly contain one or more containers, along with an internal IP and specifications on how to run the container(s). The pod we now created only contain one container. If your application is using a proxy, you might want to specify several containers in one pod.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Kubernetes deployment" duration="5">
        <p>In the previous section, we managed to run our application on Kubernetes, and while thats good and all, we need a more robust way to deploy an application.</p>
<p>Pods are the basic component in Kubernetes, but they are not reliable. In fact, they are mortal. Kubernetes will not guarantee that a running pod is running ...<br>So to deal with this, we introduce the concept of deployments.</p>
<p>Normally we let Kubernetes manage the pods for us, so instead we will create the resource Deployment. This resource will manage our application pods. The resource contains information about what Docker image to spin up in a container, environment variables and all the information Kubernetes needs to create a pod for your app. The deployment also holds information of the desired number of pods you want running.</p>
<h2>Create a deployment</h2>
<p>Lets create a deployment. Open the file <code>deployment.yaml</code> in the repository you cloned.</p>
<p>In this yaml file, we will describe the desired state for our application. For example, you can see that the field <code>replicas</code> is set to <code>3</code>. This means that we want 3 pods for this application running.</p>
<p>We need to add more information, so lets go ahead and add our Docker image.</p>
<pre><code>    spec:
      containers:
      - name: app-container
        image: INSERT_IMAGE_HERE
</code></pre>
<p>Set the field <code>spec.template.spec.containers.image</code> to <code>YOUR_DOCKERHUB_USERNAME/nais-demoapp:1.0</code>, which tells Kubernetes to pull the image nais-demoapp version 1.0 from your Docker Hub account.</p>
<p>We also need to set some metadata and labels:</p>
<ul>
<li>Set <code>metadata.name</code> to a what ever you want to name your app<br>This is the name for the Kubernetes resources created when you apply this file in a cluster.</li>
<li>Set <code>metadata.labels.app</code> to for example <code>yourname-app</code>.<br>This label will</li>
<li>Set the same app label to the fields<code>spec.selector.matchLabels.app</code> and <code>spec.template.metadata.labels</code></li>
</ul>
<p>On the last line in the file, you see that we have set the <code>containerPort</code> to <code>80</code>, which will open that port on the Pod so that we can send traffic to the container.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Kubernetes service" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ingress" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Inspect your app" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Naiserator" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="Logging and metrics" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Clean-up" duration="0">
        <p>Duration 1:00</p>


      </google-codelab-step>
    
      <google-codelab-step label="Further reading" duration="0">
        <p>Check out the NAIS documentation at <a href="https://nais.io/doc" target="_blank">https://nais.io/doc</a> and the Kubernetes documentation over at <a href="https://kubernetes.io/docs/" target="_blank">https://kubernetes.io/docs/</a>.</p>
<p>We can also recommend <a href="https://www.youtube.com/watch?v=4ht22ReBjno" target="_blank">the illustrated childrens guide to Kubernetes</a>.</p>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
